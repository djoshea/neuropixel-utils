
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for neuropixel-utils">
      
      
      
        <meta name="author" content="Daniel J. O'Shea">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.0.2">
    
    
      
        <title>Analysis of Kilosort Results - Neuropixel Utilities</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.38780c08.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f72e892.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="blue">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#analysis-of-kilosort-results" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Neuropixel Utilities" class="md-header-nav__button md-logo" aria-label="Neuropixel Utilities">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M208 0c-29.9 0-54.7 20.5-61.8 48.2-.8 0-1.4-.2-2.2-.2-35.3 0-64 28.7-64 64 0 4.8.6 9.5 1.7 14C52.5 138 32 166.6 32 200c0 12.6 3.2 24.3 8.3 34.9C16.3 248.7 0 274.3 0 304c0 33.3 20.4 61.9 49.4 73.9-.9 4.6-1.4 9.3-1.4 14.1 0 39.8 32.2 72 72 72 4.1 0 8.1-.5 12-1.2 9.6 28.5 36.2 49.2 68 49.2 39.8 0 72-32.2 72-72V64c0-35.3-28.7-64-64-64zm368 304c0-29.7-16.3-55.3-40.3-69.1 5.2-10.6 8.3-22.3 8.3-34.9 0-33.4-20.5-62-49.7-74 1-4.5 1.7-9.2 1.7-14 0-35.3-28.7-64-64-64-.8 0-1.5.2-2.2.2C422.7 20.5 397.9 0 368 0c-35.3 0-64 28.6-64 64v376c0 39.8 32.2 72 72 72 31.8 0 58.4-20.7 68-49.2 3.9.7 7.9 1.2 12 1.2 39.8 0 72-32.2 72-72 0-4.8-.5-9.5-1.4-14.1 29-12 49.4-40.6 49.4-73.9z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Neuropixel Utilities
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Analysis of Kilosort Results
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/djoshea/neuropixel-utils/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    djoshea/neuropixel-utils
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Neuropixel Utilities" class="md-nav__button md-logo" aria-label="Neuropixel Utilities">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M208 0c-29.9 0-54.7 20.5-61.8 48.2-.8 0-1.4-.2-2.2-.2-35.3 0-64 28.7-64 64 0 4.8.6 9.5 1.7 14C52.5 138 32 166.6 32 200c0 12.6 3.2 24.3 8.3 34.9C16.3 248.7 0 274.3 0 304c0 33.3 20.4 61.9 49.4 73.9-.9 4.6-1.4 9.3-1.4 14.1 0 39.8 32.2 72 72 72 4.1 0 8.1-.5 12-1.2 9.6 28.5 36.2 49.2 68 49.2 39.8 0 72-32.2 72-72V64c0-35.3-28.7-64-64-64zm368 304c0-29.7-16.3-55.3-40.3-69.1 5.2-10.6 8.3-22.3 8.3-34.9 0-33.4-20.5-62-49.7-74 1-4.5 1.7-9.2 1.7-14 0-35.3-28.7-64-64-64-.8 0-1.5.2-2.2.2C422.7 20.5 397.9 0 368 0c-35.3 0-64 28.6-64 64v376c0 39.8 32.2 72 72 72 31.8 0 58.4-20.7 68-49.2 3.9.7 7.9 1.2 12 1.2 39.8 0 72-32.2 72-72 0-4.8-.5-9.5-1.4-14.1 29-12 49.4-40.6 49.4-73.9z"/></svg>

    </a>
    Neuropixel Utilities
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/djoshea/neuropixel-utils/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    djoshea/neuropixel-utils
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../imec_dataset/" class="md-nav__link">
      Neuropixel.ImecDataset
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../kilosort/" class="md-nav__link">
      Running Kilosort
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Analysis of Kilosort Results
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Analysis of Kilosort Results
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#simple-statistics" class="md-nav__link">
    Simple statistics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kilosortmetrics" class="md-nav__link">
    KilosortMetrics
  </a>
  
    <nav class="md-nav" aria-label="KilosortMetrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plotting-drift-maps" class="md-nav__link">
    Plotting drift maps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-cluster-drift-maps" class="md-nav__link">
    Plotting cluster drift maps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-cluster-centers-of-mass" class="md-nav__link">
    Plotting cluster centers of mass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-electrical-images" class="md-nav__link">
    Plotting electrical images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../waveforms/" class="md-nav__link">
      Extracting Waveforms
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../acknowledgements/" class="md-nav__link">
      Acknowledgements and Support
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#simple-statistics" class="md-nav__link">
    Simple statistics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kilosortmetrics" class="md-nav__link">
    KilosortMetrics
  </a>
  
    <nav class="md-nav" aria-label="KilosortMetrics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plotting-drift-maps" class="md-nav__link">
    Plotting drift maps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-cluster-drift-maps" class="md-nav__link">
    Plotting cluster drift maps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-cluster-centers-of-mass" class="md-nav__link">
    Plotting cluster centers of mass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-electrical-images" class="md-nav__link">
    Plotting electrical images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/djoshea/neuropixel-utils/edit/master/docs/analysis.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="analysis-of-kilosort-results">Analysis of Kilosort Results<a class="headerlink" href="#analysis-of-kilosort-results" title="Permanent link">&para;</a></h1>
<h2 id="simple-statistics">Simple statistics<a class="headerlink" href="#simple-statistics" title="Permanent link">&para;</a></h2>
<p>Simple statistics for a KilosortDataset can be computed / printed using:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;</span> <span class="n">stats</span> <span class="p">=</span> <span class="n">ks</span><span class="p">.</span><span class="n">computeBasicStats</span><span class="p">();</span>
<span class="o">&gt;&gt;</span> <span class="n">ks</span><span class="p">.</span><span class="n">printBasicStats</span><span class="p">();</span>
<span class="n">neuropixel_01</span><span class="p">:</span> <span class="mf">3747.1</span> <span class="nb">sec</span><span class="p">,</span> <span class="mi">8181228</span> <span class="p">(</span><span class="mi">6974070</span><span class="p">)</span> <span class="n">spikes</span><span class="p">,</span> <span class="mi">592</span> <span class="p">(</span><span class="mi">187</span><span class="p">)</span> <span class="n">clusters</span> <span class="p">(</span><span class="n">with</span> <span class="n">fr</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="n">Hz</span><span class="p">)</span>

<span class="o">&gt;&gt;</span> <span class="n">stats</span>
<span class="n">stats</span> <span class="p">=</span>

  <span class="n">struct</span> <span class="s">with</span> <span class="s">fields:</span>

          <span class="n">spike_clusters</span><span class="p">:</span> <span class="p">[</span><span class="mi">8181228</span>×<span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
             <span class="n">cluster_ids</span><span class="p">:</span> <span class="p">[</span><span class="mi">592</span>×<span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
                  <span class="n">offset</span><span class="p">:</span> <span class="mi">0</span>
             <span class="n">sample_rate</span><span class="p">:</span> <span class="mi">30000</span>
             <span class="n">spike_times</span><span class="p">:</span> <span class="p">[</span><span class="mi">8181228</span>×<span class="mi">1</span> <span class="n">uint64</span><span class="p">]</span>
                 <span class="n">nSpikes</span><span class="p">:</span> <span class="mi">8181228</span>
               <span class="n">nClusters</span><span class="p">:</span> <span class="mi">592</span>
                    <span class="n">nSec</span><span class="p">:</span> <span class="mf">3.7471e+03</span>
                      <span class="n">fr</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span>×<span class="mi">591</span> <span class="n">double</span><span class="p">]</span>
                  <span class="n">thresh</span><span class="p">:</span> <span class="mi">3</span>
             <span class="n">clusterMask</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span>×<span class="mi">591</span> <span class="n">logical</span><span class="p">]</span>
    <span class="n">nClustersAboveThresh</span><span class="p">:</span> <span class="mi">187</span>
      <span class="n">nSpikesAboveThresh</span><span class="p">:</span> <span class="mi">6974070</span>
</code></pre></div>
<h2 id="kilosortmetrics">KilosortMetrics<a class="headerlink" href="#kilosortmetrics" title="Permanent link">&para;</a></h2>
<p>More computed statistics can be computed on demand by calling
<div class="highlight"><pre><span></span><code><span class="n">metrics</span> <span class="p">=</span> <span class="n">ks</span><span class="p">.</span><span class="n">computeMetrics</span><span class="p">();</span>
</code></pre></div></p>
<p>which returns a <code>Neuropixel.KilosortMetrics</code> instance. This is a catch-all class for storing all the statistics we want to compute about the results of a Kilosort run. At the moment, most of these properties are related to localizing spikes / templates / clusters in spatial coordinates on the probe. The details of these computations borrow heavily from code written by Nick Steinmetz described on the <a href="https://github.com/cortex-lab/neuropixels/wiki/Other_analysis_methods">Neuropixels wiki</a>.</p>
<p>Many properties are computed for each cluster, for each template (as multiple templates may comprise each cluster), and for each individual spike.</p>
<ul>
<li>Spatial location properties end in <code>_centerOfMass</code>, and have x,y (and someday z) along the second dimension</li>
<li><code>depth</code> properties are shorthands for the <code>y</code> spatial dimension of <code>centerOfMass</code></li>
<li><code>waveform</code> properties store the template-derived waveform taken from the largest channel</li>
<li><code>best_channels</code> properties indicate which channels best capture the electrical image of a given template or cluster. * <code>amplitude</code> properties are already in uV</li>
<li><code>is_localized</code> properties indicate whether the electrical image is sufficiently well localized in space</li>
</ul>
<p>KilosortMetrics with properties:</p>
<div class="codehilite"><pre><span></span><code>                       <span class="n">ks</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="err">×</span><span class="mi">1</span> <span class="n">Neuropixel</span><span class="p">.</span><span class="n">KilosortDataset</span><span class="p">]</span>
                  <span class="n">nSpikes</span><span class="p">:</span> <span class="mi">8181228</span>
          <span class="n">nChannelsSorted</span><span class="p">:</span> <span class="mi">371</span>
               <span class="n">nTemplates</span><span class="p">:</span> <span class="mi">653</span>
      <span class="n">nTemplateTimepoints</span><span class="p">:</span> <span class="mi">82</span>
                <span class="n">nClusters</span><span class="p">:</span> <span class="mi">592</span>
       <span class="n">nConcatenatedFiles</span><span class="p">:</span> <span class="mi">1</span>
   <span class="n">maxTemplatesPerCluster</span><span class="p">:</span> <span class="mi">11</span>
                       <span class="n">fs</span><span class="p">:</span> <span class="mi">30000</span>
               <span class="n">channelMap</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="err">×</span><span class="mi">1</span> <span class="n">Neuropixel</span><span class="p">.</span><span class="n">ChannelMap</span><span class="p">]</span>
              <span class="n">channel_ids</span><span class="p">:</span> <span class="p">[</span><span class="n">nChannelsSorted</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
      <span class="n">concatenatedSamples</span><span class="p">:</span> <span class="mi">112412208</span>
       <span class="n">concatenatedStarts</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">concatenatedNames</span><span class="p">:</span> <span class="ss">&quot;neuropixel_01&quot;</span>

             <span class="n">template_unw</span><span class="p">:</span> <span class="p">[</span><span class="n">nTemplates</span> <span class="err">×</span> <span class="n">nTemplateTimepoints</span> <span class="err">×</span> <span class="n">nChannelsSorted</span> <span class="n">single</span><span class="p">]</span> <span class="o">%</span> <span class="n">unwhitened</span> <span class="n">templates</span> <span class="k">in</span> <span class="n">original</span> <span class="k">data</span> <span class="k">scale</span>
          <span class="n">template_scaled</span><span class="p">:</span> <span class="p">[</span><span class="n">nTemplates</span> <span class="err">×</span> <span class="n">nTemplateTimepoints</span> <span class="err">×</span> <span class="n">nChannelsSorted</span> <span class="n">single</span><span class="p">]</span> <span class="o">%</span> <span class="n">unwhitened</span><span class="p">,</span> <span class="n">scaled</span> <span class="n">templates</span> <span class="k">in</span> <span class="n">uV</span>

    <span class="n">template_centerOfMass</span><span class="p">:</span> <span class="p">[</span><span class="n">nTemplates</span> <span class="err">×</span> <span class="mi">2</span> <span class="n">single</span><span class="p">]</span>
    <span class="n">template_is_localized</span><span class="p">:</span> <span class="p">[</span><span class="n">nTemplates</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">logical</span><span class="p">]</span>
        <span class="n">template_waveform</span><span class="p">:</span> <span class="p">[</span><span class="n">nTemplates</span> <span class="err">×</span> <span class="n">nTemplateTimepoints</span> <span class="n">single</span><span class="p">]</span>
     <span class="n">template_waveform_ch</span><span class="p">:</span> <span class="p">[</span><span class="n">nTemplates</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
       <span class="n">template_amplitude</span><span class="p">:</span> <span class="p">[</span><span class="n">nTemplates</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">single</span><span class="p">]</span>
             <span class="n">template_ttp</span><span class="p">:</span> <span class="p">[</span><span class="n">nTemplates</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">single</span><span class="p">]</span>
   <span class="n">template_best_channels</span><span class="p">:</span> <span class="p">[</span><span class="n">nTemplates</span> <span class="err">×</span> <span class="n">nChannelsSorted</span> <span class="n">uint32</span><span class="p">]</span>

              <span class="n">spike_times</span><span class="p">:</span> <span class="p">[</span><span class="n">nSpikes</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">uint64</span><span class="p">]</span>
          <span class="n">spike_amplitude</span><span class="p">:</span> <span class="p">[</span><span class="n">nSpikes</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">single</span><span class="p">]</span>
       <span class="n">spike_centerOfMass</span><span class="p">:</span> <span class="p">[</span><span class="n">nSpikes</span> <span class="err">×</span> <span class="mi">2</span> <span class="n">single</span><span class="p">]</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
          <span class="n">spike_templates</span><span class="p">:</span> <span class="p">[</span><span class="n">nSpikes</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
           <span class="n">spike_clusters</span><span class="p">:</span> <span class="p">[</span><span class="n">nSpikes</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
           <span class="n">spike_depth</span><span class="p">:</span> <span class="p">[</span><span class="n">nSpikes</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">single</span><span class="p">]</span>
    <span class="n">spike_is_localized</span><span class="p">:</span> <span class="p">[</span><span class="n">nSpikes</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">logical</span><span class="p">]</span>

              <span class="n">cluster_ids</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
<span class="n">cluster_template_mostUsed</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
    <span class="n">cluster_template_list</span><span class="p">:</span> <span class="err">{</span><span class="n">nClusters</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">cell</span><span class="err">}</span>
<span class="n">cluster_template_useCount</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="n">nTemplates</span> <span class="n">uint64</span><span class="p">]</span>
    <span class="n">cluster_num_templates</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
    <span class="n">cluster_best_channels</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="n">nChannelsSorted</span> <span class="n">uint32</span><span class="p">]</span>
     <span class="n">cluster_centerOfMass</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="mi">2</span> <span class="n">single</span><span class="p">]</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
     <span class="n">cluster_is_localized</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">logical</span><span class="p">]</span>
         <span class="n">cluster_waveform</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="n">nTemplateTimepoints</span> <span class="err">×</span> <span class="n">maxTemplatesPerCluster</span> <span class="n">single</span><span class="p">]</span>
      <span class="n">cluster_waveform_ch</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="n">nClusters</span> <span class="n">uint32</span><span class="p">]</span>
        <span class="n">cluster_amplitude</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">single</span><span class="p">]</span>
              <span class="n">cluster_ttp</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">single</span><span class="p">]</span>
            <span class="n">cluster_depth</span><span class="p">:</span> <span class="p">[</span><span class="n">nClusters</span> <span class="err">×</span> <span class="mi">1</span> <span class="n">single</span><span class="p">]</span>
</code></pre></div>

<p>```
</p>
<h3 id="plotting-drift-maps">Plotting drift maps<a class="headerlink" href="#plotting-drift-maps" title="Permanent link">&para;</a></h3>
<p>A drift map plots the spatial depth of all spikes over time as individual dots, where the dot color darkness increases for large amplitude spikes, allowing the eye to follow bands of spikes over time. The code for generating this plot was largely copied from the <a href="https://github.com/cortex-lab/spikes">Cortex lab spikes repo</a> and modified to use the KilosortMetrics structure and add some additional metadata.

You can plot a standard driftmap using:
<code>matlab
metrics.plotDriftmap();</code></p>
<p><img alt="driftmap" src="../images/driftmap_standard.png" title="Cluster driftmap" /></p>
<p>Significant drift events are marked in red in the raster and shown as red ticks above. You can set the driftThreshold in µm for drift events as a parameter, as well as lower the threshold for spike amplitude quantile to include smaller spikes in the calculation:</p>
<div class="highlight"><pre><span></span><code><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;driftThreshold&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;spikeAmpQuantile&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">);</span>
</code></pre></div>
<p><img alt="driftmap_sensitive" src="../images/driftmap_sensitive.png" title="Driftmap" /></p>
<p>If you have <a href="/kilosort/#segmenting-a-kilosort-dataset-into-trials">computed trial segmentation boundaries</a> stored in a <a href="/kilosort/#trialsegmentationinfo"><code>TrialSegmentationInfo</code></a> instance, you can pass them in to show the trial boundaries as blue ticks at the bottom.</p>
<div class="highlight"><pre><span></span><code><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">);</span>
</code></pre></div>
<p><img alt="driftmap_tsi" src="../images/driftmap_tsi.png" title="Driftmap" /></p>
<p>As you can see, the vertical bands where spiking activity looks very different from other timepoints occur when no trials were present. Indeed, these were time periods where the task was paused and the subject was asleep. We can mask out these regions to better assess drift over the time periods we&rsquo;re most concerned with:</p>
<div class="highlight"><pre><span></span><code><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">,</span> <span class="s">&#39;maskRegionsOutsideTrials&#39;</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</code></pre></div>
<p><img alt="driftmap_tsi_mask" src="../images/driftmap_tsi_mask.png" title="Driftmap" /></p>
<p>Or we can excise those regions of time for plotting purposes only, to simulate what would happen <a href="/imec_dataset/#excising-time-windows">if we excised those regions during pre-processing</a>. Locations where timepoints are spliced together are indicated using magenta lines.</p>
<div class="highlight"><pre><span></span><code><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">,</span> <span class="s">&#39;exciseRegionsOutsideTrials&#39;</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</code></pre></div>
<p><img alt="driftmap_tsi_excise" src="../images/driftmap_tsi_excise.png" title="Driftmap" /></p>
<h3 id="plotting-cluster-drift-maps">Plotting cluster drift maps<a class="headerlink" href="#plotting-cluster-drift-maps" title="Permanent link">&para;</a></h3>
<p>The driftmaps can help the eye spot points where spikes shift in space, but they do not indicate where Kilosort may have split a cluster over time. <code>metrics.plotClusterDriftmap</code> is similar to <code>plotDriftmap</code> except that it colors each dot according to cluster id. For these plots, it is helpful to subselect a subset of cluster ids to keep the plots from being too dense. Cluster ids tend to be roughly in order along the probe because of Kilosort&rsquo;s algorithm, so be sure to sample uniformly over the cluster ids when subselecting.</p>
<div class="highlight"><pre><span></span><code><span class="n">cluster_ids</span> <span class="p">=</span> <span class="n">metrics</span><span class="p">.</span><span class="n">cluster_ids</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="n">metrics</span><span class="p">.</span><span class="n">nClusters</span><span class="p">);</span>
<span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">,</span> <span class="s">&#39;exciseRegionsOutsideTrials&#39;</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="s">&#39;cluster_ids&#39;</span><span class="p">,</span> <span class="n">cluster_ids</span><span class="p">);</span>
</code></pre></div>
<p><img alt="clustermap" src="../images/clustermap.png" title="Cluster driftmap" /></p>
<div class="admonition tip">
<p class="admonition-title">Hover over tool tips</p>
<p>For these plots, in newer versions of Matlab, you can hover over points in the plot to see a popup tooltip that will display information about the cluster to which that point belongs.</p>
</div>
<p>You can also tweak the colors of each cluster so that larger amplitude clusters appear brighter using <code>'colorByAmp', true</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">,</span> <span class="s">&#39;exciseRegionsOutsideTrials&#39;</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="s">&#39;cluster_ids&#39;</span><span class="p">,</span> <span class="n">cluster_ids</span><span class="p">,</span> <span class="s">&#39;colorByAmp&#39;</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</code></pre></div>
<p><img alt="clustermap_colorByAmp" src="../images/clustermap_colorByAmp.png" title="Cluster driftmap" /></p>
<p>By default, larger clusters are plotted on top, but you can randomize the plotting order using <code>'zShuffleClusters', true</code>. Instead of plotting each individual spike, you can plot a smoothed estimate of cluster depth by passing <code>'showSmooth', true, 'showIndividual', false</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">,</span> <span class="s">&#39;exciseRegionsOutsideTrials&#39;</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="s">&#39;cluster_ids&#39;</span><span class="p">,</span> <span class="n">cluster_ids</span><span class="p">,</span> <span class="k">...</span>
    <span class="s">&#39;showSmooth&#39;</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="s">&#39;showIndividual&#39;</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="s">&#39;smoothWidthSeconds&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
</code></pre></div>
<p><img alt="clustermap_smooth" src="../images/clustermap_smooth.png" title="Cluster driftmap" /></p>
<h3 id="plotting-cluster-centers-of-mass">Plotting cluster centers of mass<a class="headerlink" href="#plotting-cluster-centers-of-mass" title="Permanent link">&para;</a></h3>
<p>To see the distribution of cluster waveforms over the probe:</p>
<div class="highlight"><pre><span></span><code><span class="n">metrics</span><span class="p">.</span><span class="n">plotClusterWaveformAtCenterOfMass</span><span class="p">()</span>
</code></pre></div>
<p><img alt="clustermap_com" src="../images/cluster_com.png" title="Cluster center of mass" /></p>
<div class="admonition tip">
<p class="admonition-title">Hover over tool tips</p>
<p>For these plots, in newer versions of Matlab, you can hover over waveforms in the plot to see a popup tooltip that will display information about the cluster to which that waveform belongs.</p>
<p><center>
<img alt="cluster_com_tooltip" src="../images/cluster_com_tooltip.png" title="Cluster center of mass" />
</center></p>
</div>
<h3 id="plotting-electrical-images">Plotting electrical images<a class="headerlink" href="#plotting-electrical-images" title="Permanent link">&para;</a></h3>
<p>You can plot the electrical image of each cluster&rsquo;s templates (or an individual template) as well, using <code>ymag</code> and <code>xmag</code> to zoom in after normalizing.</p>
<div class="highlight"><pre><span></span><code><span class="n">cluster_id</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">metrics</span><span class="p">.</span><span class="n">plotClusterImage</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span> <span class="s">&#39;ymag&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&#39;xmag&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<p><img alt="cluster_image" src="../images/cluster_image.png" title="Cluster image" /></p>
<p>Rather than plotting every channel, you can select the best N contiguous channels:
<div class="highlight"><pre><span></span><code><span class="n">metrics</span><span class="p">.</span><span class="n">plotClusterImage</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span> <span class="s">&#39;best_n_channels&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
</code></pre></div></p>
<p><img alt="cluster_image" src="../images/cluster_image_zoom.png" title="Cluster image" /></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../kilosort/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Running Kilosort
              </div>
            </div>
          </a>
        
        
          <a href="../waveforms/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Extracting Waveforms
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 &mdash; <a href="http://djoshea.com">Daniel J. O&#39;Shea</a>
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/djoshea" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/djoshea" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.77e55a48.min.js"></script>
      <script src="../assets/javascripts/bundle.9554a270.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>